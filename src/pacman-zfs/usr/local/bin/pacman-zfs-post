#!/usr/bin/env bash
# Post-transaction hook: Clean up old ZFS boot environments

set -euo pipefail

# Determine script directory and source library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="${SCRIPT_DIR}/../lib"

# For installed location
if [[ -f "/usr/local/lib/pacman-zfs-common.sh" ]]; then
  # shellcheck source=src/pacman-zfs-common/usr/local/lib/pacman-zfs-common.sh
  . "/usr/local/lib/pacman-zfs-common.sh"
elif [[ -f "${LIB_DIR}/pacman-zfs-common.sh" ]]; then
  # shellcheck source=src/pacman-zfs-common/usr/local/lib/pacman-zfs-common.sh
  . "${LIB_DIR}/pacman-zfs-common.sh"
else
  echo "ERROR: Cannot find pacman-zfs-common.sh library" >&2
  exit 1
fi

# Load configuration
load_config

# List all boot environment datasets, sorted by creation time (oldest first)
all_boot_envs=$(
  zfs list \
    -r \
    -H \
    -o name \
    -s creation \
    -t filesystem \
    "${ZFS_ROOT_POOL}" 2>/dev/null \
    | grep "/be-" \
    || true
)

# Count total number of boot environments
if [[ -z "$all_boot_envs" ]]; then
  boot_envs_count=0
else
  boot_envs_count=$(echo "$all_boot_envs" | wc -l)
fi

if [[ "$boot_envs_count" -eq 0 ]]; then
  echo "No boot environments found, skipping cleanup"
  exit 0
fi

echo "Found $boot_envs_count boot environments (retention: $RETENTION_COUNT)"

# Calculate how many boot environments to delete
to_delete=$((boot_envs_count - RETENTION_COUNT))
boot_envs_deleted=0

if [[ "$to_delete" -gt 0 ]]; then
  echo "Cleaning up $to_delete old boot environment(s)..."

  # Delete oldest boot environments
  echo "$all_boot_envs" | head -n "$to_delete" | while read -r boot_env; do
    echo "Removing old boot environment: $boot_env"
    if zfs destroy -r "$boot_env" 2>/dev/null; then
      boot_envs_deleted=$((boot_envs_deleted + 1))
    else
      echo "Warning: Failed to destroy $boot_env" >&2
    fi
  done

  # Check if any were actually deleted (approximate check)
  remaining_list=$(
    zfs list \
      -r \
      -H \
      -o name \
      -t filesystem \
      "${ZFS_ROOT_POOL}" 2>/dev/null \
      | grep "/be-" \
      || true
  )

  if [[ -z "$remaining_list" ]]; then
    remaining=0
  else
    remaining=$(echo "$remaining_list" | wc -l)
  fi

  if [[ "$remaining" -lt "$boot_envs_count" ]]; then
    boot_envs_deleted=$((boot_envs_count - remaining))
  fi
else
  echo "Within retention limit, no cleanup needed"
fi

# Regenerate ZFSBootMenu if boot environments were deleted
if [[ "$boot_envs_deleted" -gt 0 ]] || [[ "${ALWAYS_REGENERATE:-false}" == "true" ]]; then
  if command -v generate-zbm >/dev/null 2>&1; then
    echo "Regenerating ZFSBootMenu..."
    if generate-zbm; then
      echo "ZFSBootMenu regenerated successfully"
    else
      echo "ERROR: Failed to regenerate ZFSBootMenu" >&2
      exit 1
    fi
  else
    echo "Note: generate-zbm not found, skipping ZFSBootMenu regeneration"
    exit 0
  fi
fi

echo "Verifying ZFSBootMenu installation..."

# Verify unified EFI image created
if [[ ! -f "/boot/efi/EFI/ZFSBootMenu/vmlinuz-linux-cachyos.EFI" ]]; then
  echo "ERROR: ZFSBootMenu unified EFI image not found!" >&2
  echo "Expected: /boot/efi/EFI/ZFSBootMenu/vmlinuz-linux-cachyos.EFI" >&2
  echo "This indicates generate-zbm failed or is misconfigured" >&2
  exit 1
fi

# Verify kernels are in correct location
if [[ ! -f "/boot/vmlinuz-linux-cachyos" ]]; then
  echo "ERROR: Kernel not found in /boot (ZFS)" >&2
  echo "Expected: /boot/vmlinuz-linux-cachyos" >&2
  echo "Check that kernels are being installed to ZFS /boot, not ESP" >&2
  exit 1
fi

# Warn about stray kernels on ESP
stray_files=""
if [[ -f "/boot/efi/vmlinuz-linux-cachyos" ]]; then
  stray_files="$stray_files\n  /boot/efi/vmlinuz-linux-cachyos"
fi
if [[ -f "/boot/efi/initramfs-linux-cachyos.img" ]]; then
  stray_files="$stray_files\n  /boot/efi/initramfs-linux-cachyos.img"
fi

if [[ -n "$stray_files" ]]; then
  echo "WARNING: Found kernel or initramfs files in /boot/efi (ESP)" >&2
  echo "These should be in /boot (ZFS), not on the ESP:" >&2
  echo -e "$stray_files" >&2
  echo "This may indicate configuration drift" >&2
fi

echo "✓ ZFSBootMenu unified EFI image verified"
echo "✓ Kernels correctly located in ZFS /boot"

echo "Cleanup complete"
exit 0
