#!/usr/bin/env bash
set -euo pipefail

# Note: Some of the basis of this script was from inspecting the Calamares
# online install script on the CachyOS live ISO.
#
# See: https://github.com/CachyOS/CachyOS-Live-ISO/blob/master/archiso/airootfs/usr/local/bin/calamares-online.sh

print_usage() {
  local program="$1"
  local version="$2"
  local author="$3"

  cat <<-EOF
	$program $version

	CachyOS ZFS installer.

	USAGE:
	    $program [FLAGS]

	FLAGS:
	    -h, --help        Prints help information
	    -V, --version     Prints version information

	AUTHOR:
	    $author
	EOF
}

main() {
  if [[ -n "${DEBUG:-}" ]]; then set -x; fi
  if [[ -n "${TRACE:-}" ]]; then set -xv; fi

  # shellcheck source=vendor/lib/libsh.full.sh
  . "${0%/*}/../vendor/lib/libsh.full.sh"

  setup_traps trap_cleanup_files

  local program version author
  program="$(basename "$0")"
  version="0.1.0"
  author="Fletcher Nichol <fnichol@nichol.ca>"

  local base_path log
  # The root directory where the source code lives
  base_path="$(dirname "$0")/.."
  # The log file for the `calamares` installer
  log="/home/liveuser/calamares.install.log"

  # Parse CLI arguments and set local variables
  parse_cli_args "$program" "$version" "$author" "$@"

  need_cmd calamares
  need_cmd cp
  need_cmd dbus-launch
  need_cmd id
  need_cmd inxi
  need_cmd pacman
  need_cmd rm
  need_cmd sed

  verify_system "$program"
  freshen_system
  install_calamares_pkgs
  prep_calamares_config "$base_path"
  launch_installer "$log"

  section "Calamares installer finished with logs at: $log"
}

parse_cli_args() {
  local program version author
  program="$1"
  shift
  version="$1"
  shift
  author="$1"
  shift

  OPTIND=1
  # Parse command line flags and options
  while getopts ":hV-:" opt; do
    case $opt in
      h)
        print_usage "$program" "$version" "$author"
        exit 0
        ;;
      V)
        print_version "$program" "$version"
        exit 0
        ;;
      -)
        # long_optarg="${OPTARG#*=}"
        case "$OPTARG" in
          help)
            print_usage "$program" "$version" "$author"
            exit 0
            ;;
          version)
            print_version "$program" "$version" "true"
            exit 0
            ;;
          '')
            # "--" terminates argument processing
            break
            ;;
          *)
            print_usage "$program" "$version" "$author" >&2
            die "invalid argument --$OPTARG"
            ;;
        esac
        ;;
      \?)
        print_usage "$program" "$version" "$author" >&2
        die "invalid option: -$OPTARG"
        ;;
    esac
  done
  shift "$((OPTIND - 1))"
}

verify_system() {
  local program="$1"

  if [[ ! -d /etc/calamares ]]; then
    warn "$program must be run on a CachyOS live ISO"
    die "Program run on non-live ISO system"
  fi

  if [[ "$(id -u)" -ne 0 ]]; then
    warn "$program must be run as the root user, please re-run to try again"
    die "Program run without root permissions"
  fi
}

freshen_system() {
  section "Freshening system"

  info "Removing current keyrings"
  rm -rf /etc/pacman.d/gnupg

  info "Re-initializing keyrings"
  pacman -Sy --noconfirm archlinux-keyring cachyos-keyring
  pacman-key --init
  pacman-key --populate archlinux cachyos

  info "Syncing time with hardware clock"
  timedatectl set-ntp true
}

install_calamares_pkgs() {
  local calamares_pkg="cachyos-calamares-next"
  local python_deps=(
    python-pyqt6
    kdialog
  )

  section "Installing calamares package"

  info "Refreshing package databases"
  pacman -Sy --noconfirm

  if ! pacman -Q "$calamares_pkg" >/dev/null 2>&1; then
    info "Installing calamares package: $calamares_pkg"
    pacman -Sy --noconfirm "$calamares_pkg"
  fi

  info "Installing Python dependencies for custom modules"
  for pkg in "${python_deps[@]}"; do
    if ! pacman -Q "$pkg" >/dev/null 2>&1; then
      info "Installing Python package: $pkg"
      pacman -S --noconfirm "$pkg"
    fi
  done
}

prep_calamares_config() {
  local base_path="$1"

  section "Preparing calamares configuration and settings overrides"

  local modules_path="/etc/calamares/modules"

  cp -v \
    /usr/share/calamares/settings_online.conf \
    /usr/share/calamares/settings.conf
  update_settings_conf /usr/share/calamares/settings.conf

  info "Updating partition.conf for ESP at /boot/efi"
  sed -i \
    -e 's|^\(initialPartitioningChoice\):.*$|\1: erase|' \
    -e 's|^\(defaultFileSystemType\):.*$|\1:  "zfs"|' \
    -e 's|^\(availableFileSystemTypes\):.*$|\1: ["zfs"]|' \
    -e 's|^\(efiSystemPartition\):.*$|\1: /boot/efi|' \
    "$modules_path/partition.conf"

  find "$base_path/src/calamares/etc/calamares/scripts" -type f -exec \
    install --verbose -m 755 -D {} /etc/calamares/scripts/ \;
  find "$base_path/src/calamares/etc/calamares/modules" -type f -exec \
    install --verbose -m 644 -D {} /etc/calamares/modules/ \;

  info "Installing Python modules"
  if [[ -d "$base_path/src/calamares/modules" ]]; then
    mkdir -pv /usr/lib/calamares/modules
    cp -rv "$base_path/src/calamares/modules/"* /usr/lib/calamares/modules/
  fi

  info "Copying pacman-zfs"
  cp -rv "$base_path/src/pacman-zfs" /tmp

  info "Configuring bootloader module for ZFSBootMenu"
  # Create a custom bootloader configuration that does nothing (We handle
  # bootloader setup in post-install)
  cat >"$modules_path/bootloader.conf" <<-'EOF'
	# Bootloader configuration
	#
	# ZFSBootMenu is configured post-install, so this module is
	# essentially a no-op
	
	efiBootLoader: "none"
	EOF

  info "Calamares configuration prepared"
}

update_settings_conf() {
  local file="$1"

  info "Updating $file"
  sed -i \
    -e '
/^  config:   shellprocess_enable_ufw\.conf$/a\
\
- id:       zfs_keyfile_passphrase\
  module:   zfs_keyfile_passphrase\
  config:   zfs_keyfile_passphrase.conf\
\
- id:       copy_zfs_scripts\
  module:   shellprocess\
  config:   shellprocess_copy_zfs_scripts.conf\
\
- id:       configure_mkinitcpio\
  module:   shellprocess\
  config:   shellprocess_configure_mkinitcpio.conf\
\
- id:       configure_zfsbootmenu\
  module:   shellprocess\
  config:   shellprocess_configure_zfsbootmenu.conf\
\
- id:       configure_zfs_encryption\
  module:   shellprocess\
  config:   shellprocess_configure_zfs_encryption.conf\
\
- id:       create_baseline_boot_env\
  module:   shellprocess\
  config:   shellprocess_create_baseline_boot_env.conf\
\
- id:       install_pacman_zfs\
  module:   shellprocess\
  config:   shellprocess_install_pacman_zfs.conf\
\
- id:       setup_user_home_zfs\
  module:   shellprocess\
  config:   shellprocess_setup_user_home_zfs.conf\
\
- id:       cleanup\
  module:   shellprocess\
  config:   shellprocess_cleanup.conf
' \
    -e '
/^  - zfs$/a\
  - zfs_keyfile_passphrase
' \
    -e '
/^  - shellprocess@enable_ufw$/i\
  - shellprocess@copy_zfs_scripts\
  - shellprocess@setup_user_home_zfs\
  - shellprocess@configure_zfsbootmenu\
  - shellprocess@configure_zfs_encryption\
  - shellprocess@configure_mkinitcpio\
  - shellprocess@create_baseline_boot_env\
  - shellprocess@install_pacman_zfs
' \
    -e '
/^  - umount$/i\
  - shellprocess@cleanup
' \
    "$file"
}

launch_installer() {
  local log="$1"

  inxi -F >>"$log"

  section "Launching calamares installer and logging to: $log"

  dbus-launch calamares -D6 | tee -a "$log"
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
  main "$@" || exit 99
fi
